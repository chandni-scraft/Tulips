{% comment %}
  Renders product buy-buttons.
  Accepts:
  - product: {Object} product object.
  - block: {Object} passing the block information.
  - product_form_id: {String} product form id.
  - section_id: {String} id of section to which this snippet belongs.
  - show_pickup_availability: {Boolean} for the pickup availability. If true the pickup availability is rendered, false - not rendered (optional).

  Usage:
  {% render 'buy-buttons', block: block, product: product, product_form_id: product_form_id, section_id: section.id, show_pickup_availability: true %}
{% endcomment %}

{%- if product != blank -%}
  {%- liquid
    assign gift_card_recipient_feature_active = false
    if block.settings.show_gift_card_recipient and product.gift_card?
      assign gift_card_recipient_feature_active = true
    endif

    assign show_dynamic_checkout = false
    if block.settings.show_dynamic_checkout and gift_card_recipient_feature_active == false
      assign show_dynamic_checkout = true
    endif

    assign current_variant = product.selected_or_first_available_variant
    assign current_selling_plan_allocation = current_variant.selected_selling_plan_allocation
    if current_selling_plan_allocation == null and current_variant.requires_selling_plan
      assign current_selling_plan_allocation = current_variant.selling_plan_allocations | first
    endif
  -%}

  <product-form
    class="product-form"
    data-hide-errors="{{ gift_card_recipient_feature_active }}"
    data-section-id="{{ section.id }}"
    {% unless current_selling_plan_allocation == null %}
      data-has-selling-plan
    {% endunless %}
  >
    {%- form 'product',
      product,
      id: product_form_id,
      class: 'form',
      novalidate: 'novalidate',
      data-type: 'add-to-cart-form'
    -%}
      <input
        type="hidden"
        name="id"
        value="{{ product.selected_or_first_available_variant.id }}"
        {% if product.selected_or_first_available_variant.available == false
          or quantity_rule_soldout
          or product.selected_or_first_available_variant == null
        %}
          disabled
        {% endif %}
        class="product-variant-id"
      >

      {%- if gift_card_recipient_feature_active -%}
        {%- render 'gift-card-recipient-form', product: product, form: form, section: section -%}
      {%- endif -%}

      <div
        class="product-form__buttons"
        data-display-quantity="{{- block.settings.show_quantity -}}"
        data-display-layout="{{- block.settings.layout -}}"
        data-display-dynamics="{{- show_dynamic_checkout -}}"
      >
        {% if block.settings.show_quantity %}
          <div
            id="Quantity-Form-{{ section.id }}"
            class="product-form__input product-form__quantity{% if settings.inputs_shadow_vertical_offset != 0 and settings.inputs_shadow_vertical_offset < 0 %} product-form__quantity-top{% endif %}"
          >
            {%- assign cart_qty = cart | item_count_for_variant: product.selected_or_first_available_variant.id -%}
            <div class="product-selector__quantity ">
              <quantity-input-dawn class="quantity" data-url="{{ product.url }}" data-section="{{ section.id }}">
                <label class="quantity__label form__label visually-hidden" for="Quantity-{{ section.id }}">
                  {{ 'product.quantity' | t }}
                  <span class="quantity__rules-cart{% if cart_qty == 0 %} hidden{% endif %}">
                    <div class="loading__spinner hidden">
                      {%- render 'loading-spinner' -%}
                    </div>
                    <span
                      >(
                      {{- 'product.quantity_in_cart_html' | t: quantity: cart_qty -}}
                      )</span
                    >
                  </span>
                </label>
                <div class="quantity__wrapper">
                  <button class="quantity__button" name="minus" type="button">
                    <span class="visually-hidden">
                      {{- 'product.quantity_decrease_for_product' | t: product: product.title | escape -}}
                    </span>
                    {% render 'icon', icon_name: 'theme-minus' %}
                  </button>
                  <input
                    class="quantity__input"
                    type="number"
                    name="quantity"
                    id="Quantity-{{ section.id }}"
                    data-cart-quantity="{{ cart_qty }}"
                    data-min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                    min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                    {% if product.selected_or_first_available_variant.quantity_rule.max != null %}
                      data-max="{{ product.selected_or_first_available_variant.quantity_rule.max }}"
                      max="{{ product.selected_or_first_available_variant.quantity_rule.max }}"
                    {% endif %}
                    step="{{ product.selected_or_first_available_variant.quantity_rule.increment }}"
                    value="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                    form="{{ product_form_id }}"
                  >
                  <button class="quantity__button" name="plus" type="button">
                    <span class="visually-hidden">
                      {{- 'product.quantity_increase_for_product' | t: product: product.title | escape -}}
                    </span>
                    {% render 'icon', icon_name: 'theme-plus' %}
                  </button>
                </div>
              </quantity-input-dawn>
            </div>
            <div class="quantity__rules caption" id="Quantity-Rules-{{ section.id }}">
              {%- if product.selected_or_first_available_variant.quantity_rule.increment > 1 -%}
                <span class="divider">
                  {{-
                    'product.quantity_multiplies_of'
                    | t: quantity: product.selected_or_first_available_variant.quantity_rule.increment
                  -}}
                </span>
              {%- endif -%}
              {%- if product.selected_or_first_available_variant.quantity_rule.min > 1 -%}
                <span class="divider">
                  {{-
                    'product.quantity_minimum_of'
                    | t: quantity: product.selected_or_first_available_variant.quantity_rule.min
                  -}}
                </span>
              {%- endif -%}
              {%- if product.selected_or_first_available_variant.quantity_rule.max != null -%}
                <span class="divider">
                  {{-
                    'product.quantity_maximum_of'
                    | t: quantity: product.selected_or_first_available_variant.quantity_rule.max
                  -}}
                </span>
              {%- endif -%}
            </div>
          </div>
        {% endif %}

        {%- liquid
          assign check_against_inventory = true
          if product.selected_or_first_available_variant.inventory_management != 'shopify' or product.selected_or_first_available_variant.inventory_policy == 'continue'
            assign check_against_inventory = false
          endif
          if product.selected_or_first_available_variant.quantity_rule.min > product.selected_or_first_available_variant.inventory_quantity and check_against_inventory
            assign quantity_rule_soldout = true
          endif
        -%}
        <button
          id="ProductSubmitButton-{{ section_id }}"
          type="submit"
          name="add"
          class="product-form__submit button button--filled uppercase button--full{% if product.selected_or_first_available_variant.available == false or quantity_rule_soldout %} notify-me-trigger{% endif %}"
          {% if product.selected_or_first_available_variant.available == false
            or quantity_rule_soldout
            or product.selected_or_first_available_variant == null
          %}
            disabled
          {% endif %}
          {% if product.selected_or_first_available_variant.available == false or quantity_rule_soldout %}
            data-action="notify-me"
          {% endif %}
        >
          <span>
            {%- if product.metafields.theme.preorder.value -%}
              {{ 'product.preorder' | t }}
            {%- elsif product.selected_or_first_available_variant == null -%}
              {{ 'product.unavailable' | t }}
            {%- elsif product.selected_or_first_available_variant.available == false or quantity_rule_soldout -%}
              <span class="sold-out-text hidden">{{ 'product.sold_out' | t }}</span>
              <span class="notify-me-text">{{ 'product.notify_me' | t | default: 'Notify me' }}</span>
            {%- else -%}
              {{ 'theme.actions.add_to_cart' | t }}
            {%- endif -%}
          </span>
          <div class="loading__spinner hidden">
            {%- render 'loading-spinner' -%}
          </div>
        </button>
        {% comment %}
          {%- if product.metafields.theme.preorder.value != true -%}
            {{ form | payment_button }}
          {%- endif -%}
        {% endcomment %}
        {{ form | payment_button }}
      </div>

      <div class="product-form__error-message-wrapper" role="alert" hidden>
        <span class="product-form__error-icon">{% render 'icon', icon_name: 'theme-warning' %}</span>
        <span class="product-form__error-message"></span>
      </div>
    {%- endform -%}
    
    {%- comment -%} Out of stock notification form {%- endcomment -%}
    <div class="notify-me-form-wrapper" data-product-id="{{ product.id }}" data-variant-id="{{ product.selected_or_first_available_variant.id }}" hidden>
      <form class="notify-me-form" novalidate>
        <div class="notify-me-form__header">
          <h3>{{ 'product.notify_when_available' | t | default: 'Notify me when available' }}</h3>
          <button type="button" class="notify-me-form__close" aria-label="{{ 'theme.actions.close' | t | default: 'Close' }}">
            {% render 'icon', icon_name: 'theme-close' %}
          </button>
        </div>
        <div class="notify-me-form__content">
          <p>{{ 'product.notify_description' | t | default: 'Enter your email to be notified when this product is back in stock.' }}</p>
          <div class="field">
            <input
              type="email"
              name="email"
              id="notify-me-email-{{ section.id }}"
              class="field__input"
              required
              autocomplete="email"
              placeholder="{{ 'customer.email' | t | default: 'Email' }}"
              aria-required="true"
            >
            <label for="notify-me-email-{{ section.id }}" class="field__label visually-hidden">
              {{ 'customer.email' | t | default: 'Email' }}
            </label>
          </div>
          <button type="submit" class="button button--full-width button--primary notify-me-form__submit">
            <span class="button-text">{{ 'product.notify_me_button' | t | default: 'Notify me' }}</span>
            <div class="loading__spinner hidden">
              {%- render 'loading-spinner' -%}
            </div>
          </button>
          <div class="notify-me-form__message" role="alert" hidden></div>
        </div>
      </form>
    </div>
  </product-form>
{%- else -%}
  <div class="product-form">
    <div class="product-form__buttons form">
      <button
        type="submit"
        name="add"
        class="product-form__submit button button--full-width button--primary"
        disabled
      >
        {{ 'product.sold_out' | t }}
      </button>
    </div>
  </div>
{%- endif -%}
