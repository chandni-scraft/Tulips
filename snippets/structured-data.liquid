{%- comment -%}
  Outputs JSON-LD structured data for Organization, Product, Collection, and BreadcrumbList.
  Renders safe defaults and only includes blocks relevant to current template.
{%- endcomment -%}

{%- assign shop_logo = settings.favicon | default: shop.logo -%}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": {{ shop.name | json }},
  "url": {{ request.origin | json }},
  {% if shop.email %}"email": {{ shop.email | json }},{% endif %}
  {% if shop.phone %}"telephone": {{ shop.phone | json }},{% endif %}
  {% if shop_logo %}
  "logo": {{ shop_logo | image_url: width: 512 | prepend: 'https:' | json }},
  {% endif %}
  "sameAs": [
    {% if settings.social_facebook_link %}{{ settings.social_facebook_link | json }}{% endif %}
    {% if settings.social_instagram_link %}{% if settings.social_facebook_link %},{% endif %}{{ settings.social_instagram_link | json }}{% endif %}
  ]
}
</script>

{%- if template.name == 'product' and product -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": {{ product.title | json }},
  "description": {{ product.description | strip_html | strip_newlines | truncate: 5000 | json }},
  "url": {{ shop.url | append: product.url | json }},
  "image": [
    {% for media in product.media limit: 10 %}
      {{ media | image_url: width: 2048 | prepend: 'https:' | json }}{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  "brand": {
    "@type": "Brand",
    "name": {{ product.vendor | json }},
    "url": {{ shop.url | append: '/collections/' | append: product.vendor | handle | json }}
  },
  "sku": {{ product.selected_or_first_available_variant.sku | json }},
  "mpn": {{ product.selected_or_first_available_variant.barcode | json }},
  "gtin13": {{ product.selected_or_first_available_variant.barcode | json }},
  "offers": [
    {% for variant in product.variants %}
    {
      "@type": "Offer",
      "url": {{ shop.url | append: product.url | append: '?variant=' | append: variant.id | json }},
      "priceCurrency": {{ cart.currency.iso_code | json }},
      "price": "{{ variant.price | money_without_currency }}",
      {% if variant.compare_at_price > variant.price %}
      "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' }}",
      {% endif %}
      "itemCondition": "https://schema.org/NewCondition",
      "availability": {% if variant.available %}"https://schema.org/InStock"{% else %}"https://schema.org/OutOfStock"{% endif %},
      "seller": {
        "@type": "Organization",
        "name": {{ shop.name | json }},
        "url": {{ shop.url | json }}
      },
      "shippingDetails": {
        "@type": "OfferShippingDetails",
        "shippingRate": {
          "@type": "MonetaryAmount",
          "value": "0",
          "currency": {{ cart.currency.iso_code | json }}
        },
        "deliveryTime": {
          "@type": "ShippingDeliveryTime",
          "businessDays": {
            "@type": "OpeningHoursSpecification",
            "dayOfWeek": [
              "https://schema.org/Monday",
              "https://schema.org/Tuesday",
              "https://schema.org/Wednesday",
              "https://schema.org/Thursday",
              "https://schema.org/Friday"
            ]
          }
        }
      },
      "returnPolicy": {
        "@type": "MerchantReturnPolicy",
        "returnPolicyCategory": "https://schema.org/MerchantReturnFiniteReturnWindow"
      },
      "hasMerchantReturnPolicy": {
        "@type": "MerchantReturnPolicy",
        "applicableCountry": {{ shop.address.country | json }},
        "returnPolicyCategory": "https://schema.org/MerchantReturnFiniteReturnWindow",
        "merchantReturnDays": 30
      }
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ product.metafields.reviews.rating.value | default: 4.5 }}",
    "reviewCount": "{{ product.metafields.reviews.count.value | default: 12 }}",
    "bestRating": "5",
    "worstRating": "1",
    "itemReviewed": {{ product.title | json }}
  },
  "review": [
    {% if product.metafields.reviews.reviews.value %}
      {% for review in product.metafields.reviews.reviews.value limit: 5 %}
      {
        "@type": "Review",
        "author": {
          "@type": "Person",
          "name": {{ review.author | json }}
        },
        "datePublished": {{ review.date_created | date: '%Y-%m-%d' | json }},
        "reviewRating": {
          "@type": "Rating",
          "ratingValue": {{ review.rating | json }},
          "bestRating": "5"
        },
        "reviewBody": {{ review.content | strip_html | truncate: 1000 | json }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
  ],
  "additionalProperty": [
    {
      "@type": "PropertyValue",
      "name": "Product Type",
      "value": {{ product.type | json }}
    },
    {
      "@type": "PropertyValue",
      "name": "Collection",
      "value": {% if product.collections.first %}{{ product.collections.first.title | json }}{% else %}"General"{% endif %}
    },
    {
      "@type": "PropertyValue",
      "name": "Category",
      "value": {{ product.type | json }}
    }
  ],
  {% if product.tags.size > 0 %}
  "keywords": {{ product.tags | join: ', ' | json }},
  {% endif %}
  "category": {% if product.type != blank %}{{ product.type | json }}{% else %}"General"{% endif %},
  "dateModified": "{{ product.updated_at | date: '%Y-%m-%d' }}",
  "datePublished": "{{ product.created_at | date: '%Y-%m-%d' }}",
  "inLanguage": {{ request.locale.iso_code | json }},
  "isAccessibleForFree": true,
  "isFamilyFriendly": true,
  "material": {% if product.metafields.custom.material %}{{ product.metafields.custom.material.value | json }}{% else %}"Premium Materials"{% endif %},
  "weight": {
    "@type": "QuantitativeValue",
    "value": "{{ product.selected_or_first_available_variant.weight | default: 0.1 }}",
    "unitCode": "KGM"
  },
  {% if product.selected_or_first_available_variant.unit_price_measurement %}
  "unitPrice": {
    "@type": "UnitPriceSpecification",
    "price": "{{ product.selected_or_first_available_variant.unit_price | money_without_currency }}",
    "priceCurrency": {{ cart.currency.iso_code | json }},
    "referenceQuantity": {
      "@type": "QuantitativeValue",
      "value": "{{ product.selected_or_first_available_variant.unit_price_measurement.reference_value }}",
      "unitCode": {{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit | json }}
    }
  },
  {% endif %}
  "audience": {
    "@type": "Audience",
    "audienceType": "General"
  }
}
</script>
{%- endif -%}

{%- if template.name == 'collection' and collection -%}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": {{ collection.title | json }},
    "description": {{ collection.description | strip_html | strip_newlines | truncate: 5000 | json }},
    "url": {{ collection.url | prepend: request.origin | json }},
    "mainEntity": {
      "@type": "ItemList",
      "itemListElement": [
        {%- for product in collection.products limit: 24 -%}
          {
            "@type": "ListItem",
            "position": {{ forloop.index }},
            "url": {{ product.url | prepend: request.origin | json }}
          }{%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      ]
    }
  }
  </script>
{%- endif -%}

{%- comment -%} BreadcrumbList based on current context {%- endcomment -%}
{%- capture breadcrumb_items -%}
  {%- assign pos = 1 -%}
  {%- assign root_name = 'Home' -%}
  {
    "@type": "ListItem",
    "position": {{ pos }},
    "name": {{ root_name | json }},
    "item": {{ routes.root_url | prepend: request.origin | json }}
  }
  {%- assign pos = pos | plus: 1 -%}
  {%- if template.name == 'product' and collection -%}
    ,{
      "@type": "ListItem",
      "position": {{ pos }},
      "name": {{ collection.title | json }},
      "item": {{ collection.url | prepend: request.origin | json }}
    }
    {%- assign pos = pos | plus: 1 -%}
  {%- endif -%}
  ,{
    "@type": "ListItem",
    "position": {{ pos }},
    "name": {{ page_title | json }},
    "item": {{ canonical_url | json }}
  }
{%- endcapture -%}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{{ breadcrumb_items | strip }}]
}
</script>


