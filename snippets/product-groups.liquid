{%- liquid
  assign product_image_width = 64
  if where == 'product-card'
    assign product_image_width = 24
  endif

  assign product_groups_metaobject = shop.metaobjects[settings.metaobject_for_product_groups]
  assign product_options_thumbnails_metaobject = shop.metaobjects[settings.metaobject_for_product_options_thumbnails]
  # echo product_groups_metaobject.values | json
  # echo '<br>'
  assign groups_has_this_product = ''
  for product_group in product_groups_metaobject.values
    # echo product_group | json
    for product_group_product in product_group.group.value
      if product_group_product.id == product.id
        assign groups_has_this_product = groups_has_this_product | append: product_group.system.handle | append: ','
      endif
    endfor
  endfor
  assign groups_has_this_product_arr = groups_has_this_product | split: ','

  # echo groups_has_this_product_arr | json
-%}

<div class="product__product-groups">
  {%- for group_has_this_product in groups_has_this_product_arr -%}
    {%- assign group_metaobject = shop.metaobjects['product_groups'][group_has_this_product] -%}
    <fieldset class="product__product-group product__variant-options">
      {% if where != 'product-card' %}
      <legend class="form__label">
        {{ group_metaobject.group_by_option }}
        <span data-current-product>
          {{ product.title }}
        </span>
        </legend>
      {% endif %}
      {% assign group_metaobject_thumbnail = group_metaobject.thumbnail | handleize %}
      {% if group_metaobject_thumbnail == 'custom-image' %}
        {%- for group_metaobject_product in group_metaobject.group.value -%}
          {%- assign group_metaobject_product_current = '' -%}
          {%- if group_metaobject_product.id == product.id -%}
            {%- assign group_metaobject_product_current = 'active' -%}
          {%- endif -%}
          <label class="product-option__label product-option__label--image {{ group_metaobject_product_current }}">
            <a href="{{ group_metaobject_product.url }}" class="product-option__link media product-option__swatch product-option__swatch--{{ settings.swatches_shape }}" title="{{ group_metaobject_product.title }}">
              {% for product_option_thumbnail in product_options_thumbnails_metaobject.values %}
                {% assign product_option_thumbnail_name = product_option_thumbnail.name | strip | downcase %}
                {% assign product_title = group_metaobject_product.title | downcase %}
                {% if product_title contains product_option_thumbnail_name %}
                  {% render 'image', image: product_option_thumbnail.image, width: '128' %}
                {% endif %}
              {% endfor %}
            </a>
          </label>
        {%- endfor -%}
      {% else %}
        {%- for group_metaobject_product in group_metaobject.group.value -%}
          {%- assign group_metaobject_product_current = '' -%}
          {%- if group_metaobject_product.id == product.id -%}
            {%- assign group_metaobject_product_current = 'active' -%}
          {%- endif -%}
          <label class="product-option__label product-option__label--image {{ group_metaobject_product_current }}">
            <a href="{{ group_metaobject_product.url }}" class="product-option__link media" title="{{ group_metaobject_product.title }}">
              {% render 'image', image: group_metaobject_product.featured_image, width: '128' %}
            </a>
          </label>
        {%- endfor -%}
      {% endif %}
    </fieldset>
  {%- endfor -%}
</div>
